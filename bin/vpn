#!/usr/bin/env zsh

autoload -Uz colors && colors

function _mc_vpn_help() {
    cat <<EOF
${fg[green]}vpn${FX[reset]} ${fg[yellow]}<command>${FX[reset]}

    commands:
    ${fg[yellow]}on${FX[reset]}      - turn the vpn on
    ${fg[yellow]}off${FX[reset]}     - turn the vpn off
    ${fg[yellow]}status${FX[reset]}  - check vpn connection status

EOF
}

function _mc_vpn_start() {
    if ! _mc_vpn_status; then
        ${MC_VPN_CLIENT} connect ${MC_VPN_HOST}
    else
        echo "Already running"
    fi
}

function _mc_vpn_stop() {
    if _mc_vpn_status; then
        if [[ $(${MC_VPN_CLIENT} disconnect 2> /dev/null) =~ "state: Disconnected" ]]; then
            echo "${fg[green]}Stopped"
        else
            echo "${fg[red]}Unable to stop" >&2
            exit 1
        fi
    else
        echo "Not running"
    fi
}

function _mc_vpn_status() {
    if [[ $(${MC_VPN_CLIENT} state) =~ "state: Connected" ]]; then
        return 0
    fi
    return 1
}

case "$1" in
    on)
        _mc_vpn_start
        ;;
    off)
        _mc_vpn_stop
        ;;
    status)
        exit $(_mc_vpn_status)
        ;;
    help)
        _mc_vpn_help >&2
        exit 0
        ;;
    *)
        _mc_vpn_help >&2
        exit 1
        ;;
esac

exit 0
